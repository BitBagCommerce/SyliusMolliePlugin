<script src="https://js.mollie.com/v1/mollie.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">

    $(document).ready(function () {
        let selectedValue = false;
        let cartDiv = $("#mollie_cart_data").hide();
        let issuers = $("#issuers_data").hide();
        let input = $("#sylius_checkout_select_payment_payments_0_mollie_payment_options_molliePaymentMethods");


        initializeCreditCartFields();

        if (input.val() === 'creditcard') {
            cartDiv.show();
        }
        if (input.val() === 'ideal') {
            issuers.show();
        }

        $('.ui.dropdown').dropdown({
            onChange: function (value) {
                selectedValue = value;
                cartDiv.hide();
                issuers.hide();

                if (value === 'creditcard') {
                    cartDiv.show();
                }
                if (value === 'ideal') {
                    issuers.show();
                }
            }
        });

        function initializeCreditCartFields() {
            const mollie = Mollie(
                '{{ gatewayConfig.config['profile_id'] }}',
                {
                    locale: '{{ app.request.locale }}',
                    testmode: true
                }
            );

            const form = document.getElementsByName("sylius_checkout_select_payment")[0];

            const formError = document.getElementById("form-error");
            const submitButton = document.getElementById("next-step");
            const tokenField = document.getElementById("sylius_checkout_select_payment_payments_0_mollie_payment_options_cartToken");

            const cardHolder = mollie.createComponent("cardHolder");
            cardHolder.mount("#card-holder");

            const cardHolderError = document.getElementById("card-holder-error");

            cardHolder.addEventListener("change", event => {
                if (event.error && event.touched) {
                    cardHolderError.textContent = event.error;
                } else {
                    cardHolderError.textContent = "";
                }
            });

            const cardNumber = mollie.createComponent("cardNumber");
            cardNumber.mount("#card-number");

            const cardNumberError = document.getElementById("card-number-error");

            cardNumber.addEventListener("change", event => {
                if (event.error && event.touched) {
                    cardNumberError.textContent = event.error;
                } else {
                    cardNumberError.textContent = "";
                }
            });

            const expiryDate = mollie.createComponent("expiryDate");
            expiryDate.mount("#expiry-date");

            const expiryDateError = document.getElementById("expiry-date-error");

            expiryDate.addEventListener("change", event => {
                if (event.error && event.touched) {
                    expiryDateError.textContent = event.error;
                } else {
                    expiryDateError.textContent = "";
                }
            });

            const verificationCode = mollie.createComponent("verificationCode");
            verificationCode.mount("#verification-code");

            const verificationCodeError = document.getElementById("verification-code-error");

            verificationCode.addEventListener("change", event => {
                if (event.error && event.touched) {
                    verificationCodeError.textContent = event.error;
                } else {
                    verificationCodeError.textContent = "";
                }
            });

            function disableForm() {
                submitButton.disabled = true;
            }

            function enableForm() {
                submitButton.disabled = false;
            }

            form.addEventListener("submit", async event => {
                if (selectedValue === 'creditcard') {
                    event.preventDefault();
                    disableForm();

                    formError.textContent = "";

                    const {token, error} = await mollie.createToken();

                    if (error) {
                        enableForm();
                        formError.textContent = error.message;
                        form.classList.remove('loading');

                        return;
                    }

                    const tokenInput = document.createElement("input");
                    tokenInput.setAttribute("name", "token");
                    tokenInput.setAttribute("type", "hidden");
                    tokenInput.setAttribute("value", token);

                    form.appendChild(tokenInput);
                    tokenField.value = token;

                    form.submit();
                }
            });
        }
    });
</script>
